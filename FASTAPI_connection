pipeline {
    agent any
    stages {
        
        stage ('Backend Environment Setup') {
            steps {
                sshagent (credentials: ['AWS_SSH_KEY']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ec2-user@10.0.3.127 '
                            # Install Python and Git if they are missing
                            sudo yum install git python3 python3-pip -y;
                        '
                    """
                }
            }
        }
        
        stage ('Deploy FastAPI App') {
            steps {
                sshagent (credentials: ['AWS_SSH_KEY']) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ec2-user@10.0.3.127 '
                            # 1. Clean up and Clone
                            sudo rm -rf ~/fruits-veg_market;
                            git clone -b project_2 https://github.com/olawalelateef9/fruits-veg_market.git;
                            
                            # 2. Navigate to the project folder
                            cd fruits-veg_market;
                            
                            # 3. Install required Python packages
                            # psycopg[binary] is required for the connection string in your main.py
                            pip3 install fastapi uvicorn sqlalchemy psycopg[binary] --user;
                            
                            # 4. Stop any old version of the API currently running
                            pkill uvicorn || true;
                            
                            # 5. Start the API in the background (nohup keeps it alive after exit)
                            # Using 0.0.0.0 allows it to accept connections from your Web Node
                            nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > fastapi.log 2>&1 &
                            
                            # 6. Wait 2 seconds and check if it stayed alive
                            sleep 2;
                            ps aux | grep uvicorn;
                        '
                    """
                }
            }
        }
    }
}